# AusTIMES VEDA Table CLI

A Git-friendly CLI tool for extracting, validating, diffing, and reporting on VEDA-TIMES energy model input tables from Excel workbooks.

## Overview

The AusTIMES VEDA Table CLI (`times-tables`) enables version control workflows for VEDA-TIMES Excel input decks by creating canonical CSV "shadow tables" alongside your Excel files. This provides:

- **Git-friendly diffs**: Structured, row-level changes instead of binary Excel diffs
- **Validation**: Schema-based checks for table structure, primary keys, and required columns
- **Rich reports**: Self-contained HTML diff reports with workbook/sheet/table organization
- **Stable identifiers**: Tables maintain identity even when moved between sheets or workbooks
- **Deterministic outputs**: Canonical CSV formatting ensures stable diffs across OS and tools

### What are Shadow Tables?

Shadow tables are normalized CSV exports of VEDA tables stored in a parallel directory structure:
```
deck_root/
├── VT_*.xlsx               # Original Excel workbooks
├── SysSettings.xlsx
├── BY_Trans.xlsx
├── SupplXLS/*.xlsx
└── shadow/                 # Generated by times-tables
    ├── tables/
    │   ├── VT_Example/
    │   │   ├── FI_T__PowerPlants.csv
    │   │   └── UC_T__EmissionLimits.csv
    │   └── SupplXLS_Renewables/
    │       └── FI_T__SolarPV.csv
    └── meta/
        └── tables_index.json
```

## Installation

**Requirements**: Python 3.10+, [uv](https://docs.astral.sh/uv/) package manager, supports macOS/Linux/Windows

**Note**: This project uses **uv** for package management.

### Install uv

If you don't have uv installed:

```bash
# macOS/Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

### Using uv (Recommended)

Install directly from GitHub:

```bash
# Latest version
uv tool install git+https://github.com/dlg0/times-tables

# Or pin to a specific version (recommended)
uv tool install git+https://github.com/dlg0/times-tables@v0.1.0
```

Then use the CLI:

```bash
times-tables extract /path/to/deck
times-tables validate /path/to/deck
```

### Using pip

```bash
pip install times-tables
```

## Examples

See the [examples/](examples/) directory for:
- Sample VEDA deck workbooks
- Example shadow table outputs (CSVs and metadata)
- Detailed explanations of what to look for in outputs

**Quick demo**:
```bash
times-tables extract examples/sample_deck
times-tables validate examples/sample_deck
```

## Quick Start

### Basic Workflow

```bash
# 1. Extract VEDA tables from Excel workbooks
times-tables extract /path/to/deck_root
# ✓ Extracted 127 tables
# Creates: deck_root/shadow/tables/ and deck_root/shadow/meta/

# 2. Validate extracted tables
times-tables validate /path/to/deck_root
# ✓ All tables valid
# Returns exit code 0 if valid, 1 if errors found

# 3. Re-format CSVs (optional, ensures deterministic output)
times-tables format /path/to/deck_root
# ✓ Formatted 127 tables
# Recommended before committing to Git - guarantees stable diffs
```

### Complete Example

```bash
# Extract tables from your VEDA deck
cd ~/models/austimes_v2
times-tables extract .

# Verify everything is valid
times-tables validate .

# Format for Git (deterministic sorting and column order)
times-tables format .

# Commit shadow tables alongside Excel files
git add shadow/
git commit -m "Update energy scenarios for 2025"

# Later: diff two versions (Phase 2 feature)
times-tables diff baseline_2024/ scenario_2025/ --output changes.json
times-tables report baseline_2024/ scenario_2025/ --output changes.html
```

### What You Get

After running `extract`, you'll have:
```
deck_root/
├── VT_Renewables.xlsx      # Your original Excel files
├── SysSettings.xlsx
└── shadow/                  # Generated shadow tables
    ├── tables/
    │   ├── VT_Renewables/
    │   │   ├── fi_t__solar_pv.csv
    │   │   ├── fi_t__wind_offshore.csv
    │   │   └── uc_t__renewable_targets.csv
    │   └── SysSettings/
    │       └── fi_t__system_config.csv
    └── meta/
        └── tables_index.json    # Table metadata and identifiers
```

**Pro tip**: Add `shadow/` to your Git repository to track table changes alongside Excel files.

## Stable Identifiers

### table_id

Tables are identified by: `<table_type>__<normalized_logical_name>`

- **table_type**: FI_T, UC_T, etc. (from VEDA tag)
- **logical_name**: Parsed from VEDA tag like `~FI_T: PowerPlants`
- **normalized**: Lowercase, collapsed whitespace, alphanumeric + `_-` only
- **Fallback**: If logical name missing, uses `<table_type>__<sha1_hash>` of tag text

Example: `~FI_T: Solar PV Capacity` → `fi_t__solar_pv_capacity`

**Stability**: table_id remains constant even if:
- Table is moved within a sheet
- Sheet is moved within a workbook
- Table range changes

### workbook_id

- Derived from filename without extension
- SupplXLS files prefixed: `SupplXLS_<filename>`

Example: `VT_Renewables.xlsx` → `VT_Renewables`
Example: `SupplXLS/SolarData.xlsx` → `SupplXLS_SolarData`

## Value Normalization & Determinism

To ensure stable diffs across platforms:

- **Encoding**: UTF-8
- **Newlines**: LF (`\n`) on all platforms
- **Quoting**: QUOTE_MINIMAL (only when needed)
- **NULL values**: Stored as empty string in CSV
- **Row sorting**: Lexicographic by primary key tuple (case-sensitive)
- **Column order**: From xl2times schema if available, else first-seen order

## CLI Commands

### extract

Extracts all VEDA tables from Excel workbooks and writes canonical CSV shadow tables.

```bash
times-tables extract <deck_root> [--output-dir DIR] [-v]
```

**What it does**:
- Scans `<deck_root>/*.xlsx` and `<deck_root>/SupplXLS/*.xlsx`
- Parses VEDA tags and extracts table data via xl2times integration
- Writes deterministic CSVs sorted by primary key
- Creates metadata index for stable table identifiers

**Examples**:
```bash
# Extract to default shadow/ directory
times-tables extract ~/models/austimes_baseline

# Extract with custom output directory
times-tables extract . --output-dir=export

# Extract with verbose output (shows per-table progress)
times-tables extract . -v
```

**Output structure**:
```
deck_root/shadow/
├── tables/<workbook_id>/<table_id>.csv
└── meta/tables_index.json
```

---

### format

Canonicalizes shadow tables: sorts by primary key, applies canonical column order.

```bash
times-tables format <deck_root>
```

**What it does**:
- Sorts all rows by primary key (lexicographic order)
- Applies canonical column order from schema
- Ensures UTF-8 encoding with LF line endings (`\n`)
- Guarantees stable Git diffs across platforms and tools

**Examples**:
```bash
# Ensure deterministic CSV format (idempotent, safe to run multiple times)
times-tables format .

# Recommended workflow before committing
times-tables format . && git add shadow/ && git commit -m "Update tables"
```

**Why use this**: Even if you've extracted tables, run `format` before committing to Git to ensure byte-for-byte identical output across different environments. This is especially important for collaborative workflows.

---

### validate

Validates shadow tables against xl2times schema requirements.

```bash
times-tables validate <deck_root>
```

**What it checks**:
- Required columns present
- Primary key columns exist and non-NULL
- No duplicate primary keys within tables
- Basic type safety (if exposed by xl2times)

**Examples**:
```bash
# Validate and show errors
times-tables validate ~/models/austimes_baseline

# Use in CI/CD pipeline (exit code 0=valid, 1=errors)
if times-tables validate deck/; then
  echo "✓ All tables valid"
else
  echo "✗ Validation errors found"
  exit 1
fi
```

**Exit codes**:
- `0`: All tables valid
- `1`: Validation errors found (details printed to stderr)

---

### diff *(Phase 2)*

Computes structured diff between two deck versions.

```bash
times-tables diff <deck_a> <deck_b> [--output FILE]
```

**What it detects**:
- Tables added/removed/changed
- Column additions/removals
- Row-level changes (added/removed/modified)
- Table moves between workbooks/sheets

**Examples**:
```bash
# Diff to stdout (JSON format)
times-tables diff baseline_2024/ scenario_2025/

# Save diff to file for later analysis
times-tables diff baseline_2024/ scenario_2025/ --output changes.json
```

**Note**: This command is planned for Phase 2.

---

### report

Generates self-contained HTML diff report.

```bash
times-tables report <deck_a> <deck_b> --output FILE [--limit-rows N]
```

**Report features** (Phase 1):
- Deck summary (changed workbooks/tables counts)
- Table-level changes (added/removed/modified)
- Color-coded sections
- Self-contained HTML (inline CSS, no external dependencies)

**Examples**:
```bash
# Generate HTML report
times-tables report baseline_2024/ scenario_2025/ --output diff.html

# Limit detailed row output for large diffs
times-tables report baseline_2024/ scenario_2025/ --output diff.html --limit-rows 5000
```

**Note**: Phase 1 implementation provides basic diff summary. Row-level diff visualization is planned for Phase 2. Large diffs are truncated by default to `--limit-rows=2000` to keep file sizes manageable.

## Schema Integration

This tool integrates with [xl2times](https://github.com/etsap-TIMES/xl2times) to obtain:
- Table type definitions
- Expected columns and column order
- Primary key columns
- Basic semantic validation rules

**Fallbacks**: If xl2times doesn't expose PK or column order, the tool:
- Uses first-seen column order (persisted in `tables_index.json`)
- Logs warnings for missing schema information
- Proceeds with best-effort validation

## Performance & Scale

Designed for typical VEDA decks with tables up to ~200k rows:
- **Extract/format**: Seconds to tens of seconds
- **Diff**: Seconds on typical decks
- **Memory**: Tens to hundreds of MB for large tables
- **HTML reports**: Truncated by default to keep file size manageable

For very large diffs, use `--limit-rows` to cap detailed output.

## CI Pipeline Integration

Typical CI workflow:

```yaml
steps:
  - name: Extract shadow tables
    run: times-tables extract deck/
  
  - name: Format for canonical output
    run: times-tables format deck/
  
  - name: Validate schema
    run: times-tables validate deck/
  
  - name: Generate diff report
    run: |
      times-tables report main_deck/ pr_deck/ --output diff.html
  
  - name: Upload diff artifact
    uses: actions/upload-artifact@v3
    with:
      name: table-diff-report
      path: diff.html
```

## Troubleshooting

### Validation Errors

**Duplicate primary keys**:
```
ERROR: Table VT_Example/fi_t__powerplants has duplicate PKs:
  Row 142: (REGION1, COAL, 2030)
  Row 256: (REGION1, COAL, 2030)
```
Fix: Remove duplicate rows in Excel, then re-extract.

**Missing columns**:
```
ERROR: Table requires column 'UNITS' but not found
```
Fix: Add missing column to Excel table, then re-extract.

### Table ID Collisions

If two tables in different locations have identical types and names but different content:
```
WARNING: Potential table_id collision for fi_t__baseload
```
The tool appends a counter suffix. Add unique logical names in Excel tags to avoid this.

### Moved Tables

Tables preserve their table_id when moved between sheets. The diff report shows:
```
Table fi_t__powerplants moved from Sheet1 to Sheet2
```

## Development

### Getting Started

```bash
# Clone the repository
git clone https://github.com/austimes/times-tables.git
cd times-tables

# Install dependencies with uv
uv sync --all-extras

# Run tests
uv run pytest

# Check code style
uv run ruff check .

# Run on sample deck
uv run times-tables extract tests/fixtures/sample_deck
uv run times-tables validate tests/fixtures/sample_deck
```

### Running Tests

```bash
# Run all tests with coverage
pytest --cov=austimes_tables

# Run specific test module
pytest tests/test_extract.py

# Run tests with verbose output
pytest -v

# Check determinism (golden tests)
pytest tests/test_determinism.py -v
```

### Issue Tracking

This project uses [bd (beads)](https://github.com/beadwork/bd) for issue tracking. See [AGENTS.md](AGENTS.md) for detailed workflow.

```bash
# Check ready work
bd ready --json

# Create issue
bd create "Issue title" -t feature -p 2 --json

# Update issue status
bd update bd-123 --status in_progress --json

# Close completed issue
bd close bd-123 --reason "Completed" --json
```

### Project Structure

```
times-tables/
├── src/austimes_tables/     # Main package
│   ├── cli.py               # CLI entry point
│   ├── commands/            # Command implementations
│   │   ├── extract.py
│   │   ├── format.py
│   │   └── validate.py
│   ├── core/                # Core models and utilities
│   │   ├── models.py        # Data models (TableIndex, etc.)
│   │   ├── csv_io.py        # Deterministic CSV I/O
│   │   └── table_id.py      # Stable identifier generation
│   └── xl2_adapter/         # xl2times integration layer
├── tests/                   # Test suite
│   ├── fixtures/            # Sample test decks
│   └── test_*.py            # Test modules
├── docs/                    # Additional documentation
├── .beads/                  # bd issue tracking database
├── pyproject.toml           # Package configuration
└── README.md                # This file
```

For detailed contributing guidelines, see [CONTRIBUTING.md](CONTRIBUTING.md).

## Project Roadmap

### Phase 1 (Current)
- ✅ extract, format, validate commands
- ✅ Row and column-level diff
- ✅ Basic HTML report with workbook/sheet/table organization

### Phase 2 (Planned)
- Advanced HTML UI (collapsible sections, client-side search)
- Deeper xl2times schema integration
- Performance optimizations for very large decks

### Phase 3 (Future)
- LLM-assisted validation and diff summaries
- Web UI for interactive table editing
- Optional Excel export from shadow tables

## License & Attribution

This project is licensed under the MIT License - see [LICENSE](LICENSE) for details.

### Vendored Components

This software vendors specific components from [xl2times](https://github.com/etsap-TIMES/xl2times) (MIT License) to maintain stability and reduce runtime dependencies:

- **veda-tags.json**: VEDA table schema definitions
- **Extraction patterns**: Conceptual patterns for VEDA tag recognition (reimplemented)

See [VENDORING.md](VENDORING.md) for complete vendoring documentation including update procedures and license compatibility.

**License Compatibility**: All vendored components are MIT-licensed and compatible with this project's MIT license.

## Contributing

Contributions welcome! Please:
1. Check existing issues with `bd ready`
2. Create linked issues for discovered work
3. Follow determinism conventions (see AGENTS.md)
4. Add tests for new features
5. Update README for CLI changes

For questions or support, open an issue via `bd create`.
