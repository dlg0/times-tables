# AusTIMES Tables - Examples

This directory contains examples to help you understand what `times-tables` produces and how to use it.

## Directory Contents

```
examples/
├── README.md                    # This file
├── sample_deck/                 # Symlink to tests/fixtures/sample_deck
│   ├── SysSettings.xlsx         # System configuration workbook
│   └── VT_BaseYear.xlsx         # Base year parameters workbook
└── shadow_output/               # Example shadow table output
    ├── tables/
    │   ├── SysSettings/
    │   │   └── SysSettings__Regions__BOOK_REGIONS.csv
    │   └── VT_BaseYear/
    │       ├── VT_BaseYear__Commodities__FI_COMM.csv
    │       ├── VT_BaseYear__Parameters__FI_T__BaseParameters.csv
    │       └── VT_BaseYear__Processes__FI_PROCESS.csv
    └── meta/
        └── tables_index.json
```

## What Each Example Shows

### 1. Sample Deck (`sample_deck/`)

A minimal VEDA-TIMES deck containing:
- **SysSettings.xlsx**: System-level configuration (regions, time periods)
- **VT_BaseYear.xlsx**: Base year data (processes, commodities, parameters)

This is a symlink to the test fixtures used in the test suite.

### 2. Shadow Output (`shadow_output/`)

Generated by running `times-tables extract` on the sample deck. This shows:

#### **CSV Tables** (`shadow_output/tables/`)
- Organized by workbook: `tables/<workbook_id>/<table_id>.csv`
- Each CSV is deterministic (sorted by primary key, canonical column order)
- UTF-8 encoded with LF line endings (`\n`) for Git-friendly diffs

**Example table**: [VT_BaseYear__Parameters__FI_T__BaseParameters.csv](shadow_output/tables/VT_BaseYear/VT_BaseYear__Parameters__FI_T__BaseParameters.csv)
```csv
region,process,attribute,commodity,2020,2025,2030
REG1,ELCCOA01,EFF,ELC,0.35,0.36,0.37
REG1,ELCCOA01,STOCK,None,1000.0,None,None
REG1,ELCGAS01,CAPACT,None,8760.0,8760.0,8760.0
...
```

#### **Metadata** (`shadow_output/meta/tables_index.json`)
- Contains stable identifiers for all tables
- Tracks table locations (workbook, sheet, tag position)
- Records column names, primary keys, row counts
- SHA-256 checksums for detecting changes

**Key fields to note**:
- `table_id`: Stable identifier (e.g., `VT_BaseYear__Parameters__FI_T__BaseParameters`)
- `workbook_id`: Source workbook (`VT_BaseYear`, `SysSettings`)
- `sheet_name`: Source sheet (`Parameters`, `Regions`)
- `tag`: Original VEDA tag (`~FI_T: BaseParameters`)
- `logical_name`: Human-readable name from tag (`BaseParameters`)
- `primary_keys`: Columns that uniquely identify rows
- `csv_sha256`: Hash for detecting changes

## Generating Your Own Examples

### Extract Tables

```bash
# Extract from the sample deck
times-tables extract examples/sample_deck

# Extract from your own deck
times-tables extract /path/to/your/deck
```

**What to look for**:
- Tables are written to `shadow/tables/<workbook_id>/`
- Metadata written to `shadow/meta/tables_index.json`
- Console shows progress: "✓ Extracted N tables"

### Format Tables

```bash
# Ensure canonical CSV format
times-tables format examples/sample_deck
```

**What this does**:
- Sorts rows by primary key (lexicographic order)
- Applies canonical column order from schema
- Ensures UTF-8 + LF line endings for cross-platform consistency

**When to use**: Always run before committing to Git to guarantee deterministic diffs.

### Validate Tables

```bash
# Check for schema violations
times-tables validate examples/sample_deck
```

**What it checks**:
- Required columns present
- Primary key columns exist and non-NULL
- No duplicate primary keys within tables
- Basic type safety (if xl2times schema exposes types)

**Exit codes**:
- `0` = All valid
- `1` = Validation errors (details printed to stderr)

## Understanding Shadow Table Structure

### Table Organization

Tables are organized by **workbook**, not by sheet:

```
shadow/tables/
├── VT_BaseYear/           # All tables from VT_BaseYear.xlsx
│   ├── <table_id_1>.csv
│   └── <table_id_2>.csv
└── SysSettings/           # All tables from SysSettings.xlsx
    └── <table_id_3>.csv
```

**Why?** This structure remains stable even when you move tables between sheets within a workbook.

### Table Identifiers

Each table has a unique `table_id` constructed from:

1. **Workbook ID**: Filename without extension
   - `VT_BaseYear.xlsx` → `VT_BaseYear`
   - `SupplXLS/Renewables.xlsx` → `SupplXLS_Renewables`

2. **Sheet Name**: Original sheet name
   - `Parameters`, `Regions`, `Processes`

3. **Tag Type**: Parsed from VEDA tag
   - `~FI_T: BaseParameters` → `FI_T__BaseParameters`
   - `~BOOK_REGIONS` → `BOOK_REGIONS`

**Full table_id example**:
```
VT_BaseYear__Parameters__FI_T__BaseParameters
└─────┬─────┘ └───┬────┘  └────────┬─────────┘
  workbook     sheet       normalized tag
```

### CSV Determinism

Shadow tables use strict formatting for stable Git diffs:

1. **Encoding**: UTF-8 (no BOM)
2. **Line endings**: LF (`\n`) on all platforms
3. **Quoting**: Minimal (only when needed for commas/quotes)
4. **Row order**: Sorted by primary key tuple (lexicographic, case-sensitive)
5. **Column order**: From xl2times schema or first-seen order
6. **NULL representation**: Empty string in CSV, `None` as text for explicit None

**Example**: Same table extracted on macOS, Linux, Windows will be byte-for-byte identical.

## Common Use Cases

### Version Control

```bash
# Initial extraction
times-tables extract .
times-tables format .
git add shadow/
git commit -m "Initial shadow tables"

# After modifying Excel files
times-tables extract .
times-tables format .
git diff shadow/  # See row-level changes

# Commit changes
git add shadow/
git commit -m "Update coal plant efficiency parameters"
```

**Tip**: The diff shows exactly which rows changed, added, or removed.

### CI/CD Pipeline

```bash
# In your CI workflow
times-tables extract deck/
times-tables format deck/
times-tables validate deck/  # Exit code 1 if errors

# Validation catches issues like:
# - Duplicate primary keys
# - Missing required columns
# - Invalid table structure
```

### Collaborative Workflows

When multiple team members edit different workbooks:

```bash
# Alice edits VT_Renewables.xlsx
# Bob edits VT_Transport.xlsx

# Merge is clean because:
# - Different workbooks → different shadow table directories
# - Deterministic formatting → no spurious conflicts
# - Metadata tracks checksums → detects concurrent edits
```

## What to Look For

### In CSV Files

✅ **Good signs**:
- Headers match expected columns for that table type
- Rows sorted consistently (e.g., by region, then process, then year)
- No duplicate primary key combinations
- Clean data (no `#REF!`, `#VALUE!` errors from Excel)

❌ **Red flags**:
- Missing header row
- Inconsistent column order across extractions
- Duplicate rows with identical primary keys
- Excel formula errors appearing as values

### In tables_index.json

✅ **Good signs**:
- `table_id` follows naming convention
- `logical_name` is human-readable (if present)
- `primary_keys` correctly identifies unique row identifiers
- `csv_sha256` changes when table contents change

❌ **Red flags**:
- `table_id` contains hash instead of logical name (indicates unnamed table)
- Empty `primary_keys` array (table can't be validated)
- `csv_sha256` unchanged but CSV file modified (indicates formatting issue)

## Next Steps

1. **Try on your own deck**: Run extract/format/validate on a real VEDA deck
2. **Check the diffs**: Make a small change in Excel and see the CSV diff
3. **Read the main README**: [../README.md](../README.md) for full CLI reference
4. **Explore validation**: Intentionally break a table to see validation errors

## Questions?

- **CLI usage**: See [../README.md](../README.md)
- **Development**: See [../CONTRIBUTING.md](../CONTRIBUTING.md)
- **Issue tracking**: Use `bd ready` to find issues or `bd create` to report bugs
